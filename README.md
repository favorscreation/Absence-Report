# 欠席・遅刻・早退連絡票システム

このリポジトリは、欠席・遅刻・早退連絡票をWebフォームで受け付け、Google スプレッドシートに記録するシステムのソースコードを提供します。重複送信の防止機能も実装されています。


## システム構成

このシステムは、以下の3つのコンポーネントで構成されます。

1. **Webフォーム (`index.html`):** ユーザーが連絡情報を記入するためのHTMLフォームです。  必須項目と任意項目が明確に区別されています。  `styles.css` (別途作成) を使用してスタイルを設定できます。

2. **クライアントサイドJavaScript (`script.js`):** フォームのUIを制御するためのJavaScriptコードです。  "その他" オプションを選択した際に、追加の入力欄を表示・非表示する機能を提供します。 フォームの送信処理自体は行いません。

3. **Google Apps Script:** フォームの送信処理、重複送信防止、データのスプレッドシートへの書き込みを行います。  UUIDを用いた重複送信防止機構と、詳細なエラー処理が組み込まれています。


## 使用方法

1. **Google スプレッドシートの準備:**

   - 新しいGoogle スプレッドシートを作成します。
   - スプレッドシートに `"Submissions"` という名前のシートを追加します。このシートには、重複送信を防止するためのUUIDが格納されます。  最低でも19列を用意してください (フォーム項目 + UUID)。

2. **Google Apps Scriptの設定:**

   - Google Apps Script を開き、新しいプロジェクトを作成します。
   - このREADMEに含まれる `index.html`、`script.js`、Google Apps Scriptコードをそれぞれコピーして、Apps Script プロジェクトに追加します。
   - Google Apps Scriptコード内の `YOUR_SPREADSHEET_ID` と `YOUR_SHEET_GID` を、それぞれ自分のスプレッドシートのIDとシートのGIDに置き換えます。
     - スプレッドシートIDは、スプレッドシートのURL (`https://docs.google.com/spreadsheets/d/{スプレッドシートID}/edit`) の `{スプレッドシートID}` 部分です。
     - シートGIDは、スプレッドシートを開き、ブラウザのアドレスバーを確認すると `gid={GID}` の部分で確認できます。

3. **Webアプリのデプロイ:**

   - Apps Script のメニューから「デプロイ」>「新しいデプロイメント」を選択します。
   - 「種類」を「ウェブアプリ」に設定します。
   - 「誰がアクセスできるか」を適切に設定します（例: 特定のユーザー、全員）。
   - 「デプロイ」ボタンをクリックします。
   - デプロイが完了すると、WebアプリのURLが表示されます。このURLを使用してフォームにアクセスします。

4. **フォームのスタイル設定 (任意):**

   - `styles.css` ファイルを作成し、フォームのスタイルをカスタマイズできます。


## ファイル構成

- `index.html`: WebフォームのHTMLファイル
- `script.js`: クライアントサイドJavaScriptファイル (UI制御)
- `appsscript.js`: Google Apps Scriptファイル (フォーム送信処理、データ保存)


## 重複送信防止

このシステムは、UUID (Universally Unique Identifier) を使用して重複送信を防止します。各送信には一意のUUIDが生成され、Google スプレッドシートの `"Submissions"` シートに記録されます。既に存在するUUIDの送信は拒否されます。


## エラー処理

Google Apps Script コードには、JSON パースエラー、スプレッドシートアクセスエラーなど、様々なエラーに対する処理が実装されています。エラーが発生した場合、エラーメッセージがログに出力され、クライアントにはエラーレスポンスが返されます。


## 関数の概要 (Google Apps Script)

- `generateUUID()`: UUIDを生成します。
- `doGet(e)`: GETリクエストを処理します (このシステムでは使用されません)。
- `doPost(e)`: POSTリクエストを処理し、データの保存と重複チェックを行います。
- `writeHeaderRowIfNeeded(sheet)`: スプレッドシートにヘッダー行が存在しない場合に、ヘッダー行を追加します。
- `prepareDataForSpreadsheet(data)`: フォームデータを受け取り、スプレッドシートに書き込むための適切な配列に変換します。


## 注意点

- Google Apps Script がスプレッドシートにアクセスするための適切な権限を持っていることを確認してください。
- スプレッドシートに十分な列数 (最低19列) が確保されていることを確認してください。


このシステムを使用することで、欠席・遅刻・早退の連絡を効率的に管理することができます。


## ライセンス

MIT License
